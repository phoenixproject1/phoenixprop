<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>چارت + ترید (V02)</title>
  <style>
    body { font-family: Tahoma, sans-serif; background: #fafafa; margin:0; padding:0; }
    h1 { text-align:center; margin:16px 0; }
    .container { display:flex; justify-content:center; gap:20px; max-width:1400px; margin:20px auto; }
    .tradingview-widget-container { flex:3; min-width:800px; height:600px; border:1px solid #ccc; border-radius:12px; overflow:hidden; box-shadow:0 0 15px rgba(0,0,0,0.1); background:#fafafa;}
    .price-box { flex:1; min-width:320px; border:1px solid #ccc; border-radius:12px; background:#fff; box-shadow:0 0 10px rgba(0,0,0,0.1); padding:15px; text-align:left; overflow-y:hidden;}
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:8px; border:1px solid #ddd; text-align:center; font-size:14px; }
    th { background:#f5f5f5; color:black; font-weight:bold; }
    tr:hover { background:#f0f8ff; }
    tr.selected { background:#d0e7ff !important; }
    .ask { color: blue; font-weight:bold; }
    .bid { color: green; font-weight:bold; }
    .change-pos { color: darkgreen; font-weight:bold; }
    .change-neg { color: darkred; font-weight:bold; }

    /* trade area */
    .trade-box { max-width:1200px; margin:20px auto 40px; background:#fff; padding:15px; border-radius:12px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    .trade-controls { margin-bottom:12px; text-align:center; }
    .trade-controls input, .trade-controls button { margin:5px; padding:8px; }
    .buy-btn { background: #1e88e5; color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer; }
    .sell-btn { background: #e53935; color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer; }
    .settings-btn { background:#555; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; }
    .close-btn { background:#444; color:#fff; border:none; border-radius:6px; padding:5px 10px; cursor:pointer; }

    .type-buy { color: #0b63b8; font-weight:bold; }   /* آبی */
    .type-sell { color: #b81a1a; font-weight:bold; }  /* قرمز */
    .pnl-pos { color: #0b63b8; font-weight:bold; }     /* سود => آبی */
    .pnl-neg { color: #b81a1a; font-weight:bold; }     /* ضرر => قرمز */

    .balance-box { margin-top:12px; padding:10px; background:#f9f9f9; border:1px solid #ddd; border-radius:8px; font-size:14px; text-align:center; }
    .balance-pos { color: green; font-weight:bold; }
    .balance-neg { color: red; font-weight:bold; }

    /* modal */
    .modal { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:2000; }
    .modal-content { background:#fff; padding:18px; border-radius:10px; width:360px; text-align:center; }
    .modal-content label { display:block; margin-top:8px; text-align:right; }
    .small { font-size:13px; color:#666; margin-top:6px; }
    .remove-x { cursor:pointer; color:red; font-weight:bold; margin-left:6px; }
  </style>
</head>
<body>
  <h1>چارت بازار + سیستم ترید (V02)</h1>

  <div id="header-container"></div>

  <div class="container">
    <div class="tradingview-widget-container">
      <div id="tradingview_chart"></div>
    </div>

    <div class="price-box">
      <h3>آخرین قیمت‌ها</h3>
      <table id="price-table">
        <thead>
          <tr>
            <th>Ask</th>
            <th>Bid</th>
            <th>Change %</th>
            <th>Symbol</th>
          </tr>
        </thead>
        <tbody>
          <tr data-symbol="BTCUSDT">
            <td id="ask-BTCUSDT" class="ask">---</td>
            <td id="bid-BTCUSDT" class="bid">---</td>
            <td id="change-BTCUSDT">---</td>
            <td>BTCUSDT</td>
          </tr>
          <tr data-symbol="ETHUSDT">
            <td id="ask-ETHUSDT" class="ask">---</td>
            <td id="bid-ETHUSDT" class="bid">---</td>
            <td id="change-ETHUSDT">---</td>
            <td>ETHUSDT</td>
          </tr>
          <tr data-symbol="SOLUSDT">
            <td id="ask-SOLUSDT" class="ask">---</td>
            <td id="bid-SOLUSDT" class="bid">---</td>
            <td id="change-SOLUSDT">---</td>
            <td>SOLUSDT</td>
          </tr>
          <tr data-symbol="XRPUSDT">
            <td id="ask-XRPUSDT" class="ask">---</td>
            <td id="bid-XRPUSDT" class="bid">---</td>
            <td id="change-XRPUSDT">---</td>
            <td>XRPUSDT</td>
          </tr>
        </tbody>
      </table>
      <div class="small">برای تغییر نماد روی سطر آن کلیک کنید — سطر انتخابی هایلایت می‌شود.</div>
    </div>
  </div>

  <div class="trade-box">
    <div class="trade-controls">
      حجم: <input type="number" id="tradeVolume" value="1" min="0.01" step="0.01" style="width:90px;">
      <button class="buy-btn" onclick="openTrade('BUY')">خرید</button>
      <button class="sell-btn" onclick="openTrade('SELL')">فروش</button>
      <button class="settings-btn" onclick="openSettings()">⚙️ تنظیمات</button>
    </div>

    <table id="trades-table">
      <thead>
        <tr>
          <th>Symbol</th>
          <th>نوع</th>
          <th>حجم</th>
          <th>قیمت ورود</th>
          <th>سود/ضرر</th>
          <th>کمیسیون (USDT)</th>
          <th>TP</th>
          <th>SL</th>
          <th>TS</th>
          <th>تنظیمات</th>
          <th>بستن</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="balanceBox" class="balance-box">
      موجودی واقعی: <span id="realBalanceValue">10000.00</span> USDT
      (<span id="realBalancePercent">0.00%</span>) &nbsp; | &nbsp;
      موجودی کل (Equity): <span id="equityValue">10000.00</span> USDT
      (<span id="equityPercent">0.00%</span>)
    </div>
  </div>

  <!-- تنظیمات (Modal) -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <h3>تنظیمات کلی</h3>
      <label style="text-align:right;">کمیسیون معاملات (%)</label>
      <input id="commissionInput" type="number" value="0.1" step="0.01" style="width:120px;">
      <label style="text-align:right;">حد ضرر روزانه (%)</label>
      <input id="dailyDDInput" type="number" value="2" step="0.1" style="width:120px;">
      <label style="text-align:right;">حد ضرر کلی (%)</label>
      <input id="totalDDInput" type="number" value="10" step="0.1" style="width:120px;">
      <div style="margin-top:12px;">
        <button onclick="saveSettings()">ذخیره</button>
        <button onclick="closeSettings()">بستن</button>
      </div>
      <div class="small" style="margin-top:8px;">
        توجه: کمیسیون هنگام باز و بسته شدن معامله اعمال می‌شود. Drawdown ها به‌صورت درصد از موجودی اولیه (initialBalance) محاسبه می‌شوند.
      </div>
    </div>
  </div>

  <!-- Modal تنظیم TP/SL/TS (همان modal قبلی موجود در V01) -->
  <div id="tradeSettingsModal" class="modal">
    <div class="modal-content">
      <h3>تنظیم حد سود/حد ضرر/Trailing</h3>
      <label style="text-align:right;">Take Profit (TP)</label>
      <input id="tpInput" type="number" placeholder="مثلاً 25000">
      <label style="text-align:right;">Stop Loss (SL)</label>
      <input id="slInput" type="number" placeholder="مثلاً 19000">
      <label style="text-align:right;">Trailing Stop (TS) (دلاری)</label>
      <input id="tsInput" type="number" placeholder="مثلاً 200">
      <div style="margin-top:10px;">
        <button onclick="saveTradeSettings()">ذخیره</button>
        <button onclick="closeTradeSettings()">بستن</button>
      </div>
    </div>
  </div>

  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    // === state ===
    const initialBalance = 10000;
    let balance = initialBalance;              // موجودی واقعی (Realized)
    let trades = [];                           // لیست معاملات باز
    let commissionPercent = 0.1;               // درصد کمیسیون (مثلاً 0.1 => 0.1%)
    let dailyDrawdownPercent = 2;              // درصد حد ضرر روزانه (از initialBalance)
    let totalDrawdownPercent = 10;             // درصد حد ضرر کلی (از initialBalance)
    let dailyLossAccum = 0;                    // جمع ضررهای روزانه (USDT) — ساده‌شده (persist نه شده)
    let totalLossAccum = 0;                    // جمع ضرر کلی (USDT)
    let tradingLocked = false;                 // قفلِ ترید وقتی Drawdown رد شد
    let selectedTradeIndex = null;             // برای modal TP/SL/TS

    // === chart loader ===
    function loadChart(symbol) {
      document.getElementById("tradingview_chart").innerHTML = "";
      new TradingView.widget({
        "container_id": "tradingview_chart",
        "width": "100%",
        "height": "600",
        "symbol": "BINANCE:" + symbol,
        "interval": "60",
        "timezone": "Etc/UTC",
        "theme": "light",
        "style": "1",
        "locale": "fa",
        "toolbar_bg": "#f1f3f6",
        "enable_publishing": false,
        "allow_symbol_change": false,
        "hide_top_toolbar": false,
        "save_image": false
      });
    }

    // === helper: format ===
    function f(n){ return (typeof n === 'number') ? n.toFixed(2) : n; }

    // === Initialization ===
    document.addEventListener("DOMContentLoaded", () => {
      loadChart("BTCUSDT");
      attachSymbolRowClicks();
      updatePrices(); // initial
      setInterval(updatePrices, 5000);
      renderTrades(); // initial render
    });

    // === Attach click on symbol rows (highlight + load chart) ===
    function attachSymbolRowClicks(){
      document.querySelectorAll("#price-table tbody tr").forEach(row=>{
        row.addEventListener("click", ()=>{
          if(tradingLocked){
            // حتی با قفل هم اجازه تغییر چارت بدیم؛ ولی ترید بسته میمونه
          }
          document.querySelectorAll("#price-table tbody tr").forEach(r=>r.classList.remove("selected"));
          row.classList.add("selected");
          const symbol = row.dataset.symbol;
          if(symbol) loadChart(symbol);
        });
      });
    }

    // === Update prices from Binance and update unrealized PnL ===
    async function updatePrices(){
      const symbols = ["BTCUSDT","ETHUSDT","SOLUSDT","XRPUSDT"];
      for(const sym of symbols){
        try{
          const res = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${sym}`);
          const data = await res.json();
          // guard
          if(!data || !data.bidPrice) continue;
          const bid = parseFloat(data.bidPrice);
          const ask = parseFloat(data.askPrice);
          const change = parseFloat(data.priceChangePercent);

          const bidEl = document.getElementById("bid-"+sym);
          const askEl = document.getElementById("ask-"+sym);
          const changeEl = document.getElementById("change-"+sym);
          if(!bidEl || !askEl || !changeEl) continue;

          // flash effect
          if(bidEl.textContent !== '---' && !isNaN(parseFloat(bidEl.textContent))){
            if(bid > parseFloat(bidEl.textContent)) { bidEl.classList.add("flash-green"); }
            else if(bid < parseFloat(bidEl.textContent)) { bidEl.classList.add("flash-red"); }
          }
          if(askEl.textContent !== '---' && !isNaN(parseFloat(askEl.textContent))){
            if(ask > parseFloat(askEl.textContent)) { askEl.classList.add("flash-green"); }
            else if(ask < parseFloat(askEl.textContent)) { askEl.classList.add("flash-red"); }
          }

          askEl.textContent = ask.toFixed(2);
          bidEl.textContent = bid.toFixed(2);
          changeEl.textContent = change.toFixed(2) + "%";
          changeEl.className = change >= 0 ? "change-pos" : "change-neg";

          setTimeout(()=>{
            bidEl.classList.remove("flash-green","flash-red");
            askEl.classList.remove("flash-green","flash-red");
          },800);

          // update unrealized PnL for trades of this symbol
          trades.forEach(tr=>{
            if(tr.symbol === sym){
              const price = (tr.type === "BUY") ? bid : ask;
              tr.pnl = ( (tr.type === "BUY" ? (price - tr.entry) : (tr.entry - price)) * tr.volume );
              // check auto TP/SL/TS (reuse logic from V01)
              // TP
              if(tr.tp && ((tr.type==="BUY" && price >= tr.tp) || (tr.type==="SELL" && price <= tr.tp))){
                closeTradeByIndex(tr.__index, true, "TP Hit");
              } else if(tr.sl && ((tr.type==="BUY" && price <= tr.sl) || (tr.type==="SELL" && price >= tr.sl))){
                closeTradeByIndex(tr.__index, true, "SL Hit");
              } else if(tr.ts){
                if(tr.trailActive == null) tr.trailActive = tr.entry;
                if(tr.type === "BUY"){
                  if(price > tr.trailActive) tr.trailActive = price;
                  if(price <= tr.trailActive - tr.ts){
                    closeTradeByIndex(tr.__index, true, "TS Hit");
                  }
                } else {
                  if(price < tr.trailActive) tr.trailActive = price;
                  if(price >= tr.trailActive + tr.ts){
                    closeTradeByIndex(tr.__index, true, "TS Hit");
                  }
                }
              }
            }
          });
        }catch(e){
          console.error("updatePrices error", e);
        }
      }
      // after updating prices & pnl, re-render trades & balances
      renderTrades();
    }

    // === open trade ===
    function openTrade(type){
      if(tradingLocked) { alert("ترید قفل شده — حد ضرر روزانه یا کلی رد شده."); return; }
      const volume = parseFloat(document.getElementById("tradeVolume").value) || 1;
      // use currently selected symbol in price table (if none, default BTCUSDT)
      const selectedRow = document.querySelector("#price-table tbody tr.selected");
      const symbol = selectedRow ? selectedRow.dataset.symbol : "BTCUSDT";
      const askText = document.getElementById("ask-"+symbol)?.textContent || '0';
      const bidText = document.getElementById("bid-"+symbol)?.textContent || '0';
      const price = (type === "BUY") ? parseFloat(askText) : parseFloat(bidText);
      if(!price || isNaN(price)){ alert("قیمت معتبر نیست، لطفاً چند لحظه صبر کنید تا قیمت بارگذاری شود."); return; }

      // commission applied on open
      const commissionFeeOpen = price * volume * (commissionPercent/100);
      balance -= commissionFeeOpen;

      // create trade object
      const trade = {
        id: Date.now() + Math.random(), // unique
        __index: null, // will be filled in render
        symbol,
        type,
        volume,
        entry: price,
        pnl: 0,
        commissionOpen: commissionFeeOpen,
        commissionClose: 0,
        tp: null,
        sl: null,
        ts: null,
        trailActive: null
      };
      trades.push(trade);
      renderTrades();
      updateBalanceDisplay();
    }

    // === render trades table ===
    function renderTrades(){
      const tbody = document.querySelector("#trades-table tbody");
      tbody.innerHTML = "";
      // assign indices for close-by-index usage
      trades.forEach((t, idx)=> t.__index = idx);

      // compute equity
      let unrealized = 0;
      trades.forEach(t => unrealized += (parseFloat(t.pnl) || 0));
      const equity = balance + unrealized;

      trades.forEach((t, i) => {
        const trEl = document.createElement("tr");
        const typeClass = (t.type === "BUY") ? "type-buy" : "type-sell";
        const pnlClass = (t.pnl >= 0) ? "pnl-pos" : "pnl-neg";
        const commissionDisplay = (t.commissionOpen || 0).toFixed(2);
        trEl.innerHTML = `
          <td>${t.symbol}</td>
          <td class="${typeClass}">${t.type}</td>
          <td>${t.volume}</td>
          <td>${f(t.entry)}</td>
          <td id="pnl-${i}" class="${pnlClass}">${f(t.pnl)}</td>
          <td>${commissionDisplay}</td>
          <td>${t.tp ? f(t.tp) + ' <span class="remove-x" onclick="removeSetting('+i+',\\'tp\\')">✖</span>' : '-'}</td>
          <td>${t.sl ? f(t.sl) + ' <span class="remove-x" onclick="removeSetting('+i+',\\'sl\\')">✖</span>' : '-'}</td>
          <td>${t.ts ? f(t.ts) + ' <span class="remove-x" onclick="removeSetting('+i+',\\'ts\\')">✖</span>' : '-'}</td>
          <td><button class="settings-btn" onclick="openTradeSettings(${i})">⚙️</button></td>
          <td><button class="close-btn" onclick="closeTradeByIndex(${i}, false, 'Manual')">بستن</button></td>
        `;
        tbody.appendChild(trEl);
      });

      // update balance/equity displays
      document.getElementById("realBalanceValue").textContent = balance.toFixed(2);
      document.getElementById("equityValue").textContent = equity.toFixed(2);

      const realChange = ((balance - initialBalance)/initialBalance*100).toFixed(2);
      const equityChange = ((equity - initialBalance)/initialBalance*100).toFixed(2);
      document.getElementById("realBalancePercent").textContent = realChange + "%";
      document.getElementById("equityPercent").textContent = equityChange + "%";

      // color classes
      document.getElementById("realBalanceValue").className = (balance >= initialBalance) ? 'balance-pos' : 'balance-neg';
      document.getElementById("equityValue").className = (equity >= initialBalance) ? 'balance-pos' : 'balance-neg';
      document.getElementById("realBalancePercent").className = (realChange >= 0) ? 'balance-pos' : 'balance-neg';
      document.getElementById("equityPercent").className = (equityChange >= 0) ? 'balance-pos' : 'balance-neg';
    }

    // === close trade by index ===
    function closeTradeByIndex(index, auto=false, reason="Manual"){
      if(index < 0 || index >= trades.length) return;
      const tr = trades[index];
      // compute close commission
      // use last known price for symbol (bid for BUY, ask for SELL)
      const bidText = document.getElementById("bid-"+tr.symbol)?.textContent || tr.entry;
      const askText = document.getElementById("ask-"+tr.symbol)?.textContent || tr.entry;
      const closePrice = (tr.type === "BUY") ? parseFloat(bidText) : parseFloat(askText);
      const commissionFeeClose = closePrice * tr.volume * (commissionPercent/100);

      // realized pnl
      const realizedPnL = tr.pnl || 0;
      // apply close commission
      balance -= commissionFeeClose;
      // update accumulative losses if negative realized
      if(realizedPnL < 0){
        dailyLossAccum += Math.abs(realizedPnL);
        totalLossAccum += Math.abs(realizedPnL);
      }
      // add pnl to balance (realized)
      balance += realizedPnL;

      // remove trade
      trades.splice(index,1);
      // after closing, check drawdowns
      checkDrawdowns();
      renderTrades();
      if(auto){
        alert("معامله به دلیل " + reason + " بسته شد");
      }
    }

    // === remove TP/SL/TS on demand ===
    function removeSetting(i, field){
      if(!trades[i]) return;
      trades[i][field] = null;
      if(field === 'ts') trades[i].trailActive = null;
      renderTrades();
    }

    // === open trade settings modal for a trade ===
    function openTradeSettings(i){
      selectedTradeIndex = i;
      const t = trades[i];
      document.getElementById("tpInput").value = t.tp || "";
      document.getElementById("slInput").value = t.sl || "";
      document.getElementById("tsInput").value = t.ts || "";
      document.getElementById("tradeSettingsModal").style.display = "flex";
    }
    function saveTradeSettings(){
      const tp = document.getElementById("tpInput").value || null;
      const sl = document.getElementById("slInput").value || null;
      const ts = document.getElementById("tsInput").value || null;
      if(selectedTradeIndex !== null && trades[selectedTradeIndex]){
        trades[selectedTradeIndex].tp = tp ? parseFloat(tp) : null;
        trades[selectedTradeIndex].sl = sl ? parseFloat(sl) : null;
        trades[selectedTradeIndex].ts = ts ? parseFloat(ts) : null;
        trades[selectedTradeIndex].trailActive = null;
      }
      closeTradeSettings();
      renderTrades();
    }
    function closeTradeSettings(){ document.getElementById("tradeSettingsModal").style.display = "none"; selectedTradeIndex = null; }

    // === settings modal (global) ===
    function openSettings(){ document.getElementById("settingsModal").style.display = "flex"; }
    function closeSettings(){ document.getElementById("settingsModal").style.display = "none"; }
    function saveSettings(){
      commissionPercent = parseFloat(document.getElementById("commissionInput").value) || commissionPercent;
      dailyDrawdownPercent = parseFloat(document.getElementById("dailyDDInput").value) || dailyDrawdownPercent;
      totalDrawdownPercent = parseFloat(document.getElementById("totalDDInput").value) || totalDrawdownPercent;
      closeSettings();
      alert("تنظیمات ذخیره شد.");
    }

    // === check drawdowns and lock trading if exceeded ===
    function checkDrawdowns(){
      const dailyLimitUSDT = initialBalance * (dailyDrawdownPercent/100);
      const totalLimitUSDT = initialBalance * (totalDrawdownPercent/100);
      if(dailyLossAccum >= dailyLimitUSDT){
        tradingLocked = true;
        alert("⚠️ شما حد ضرر روزانه را رد کرده‌اید؛ ترید قفل شد تا فردا.");
      }
      if(totalLossAccum >= totalLimitUSDT){
        tradingLocked = true;
        alert("⛔ شما حد ضرر کلی را رد کرده‌اید؛ ترید دائماً قفل شد.");
      }
    }

    // === update balance display helper ===
    function updateBalanceDisplay(){
      // recompute equity
      let unrealized = 0;
      trades.forEach(t=> unrealized += (parseFloat(t.pnl) || 0));
      const equity = balance + unrealized;
      document.getElementById("realBalanceValue").textContent = balance.toFixed(2);
      document.getElementById("equityValue").textContent = equity.toFixed(2);
      document.getElementById("realBalancePercent").textContent = (((balance-initialBalance)/initialBalance)*100).toFixed(2) + "%";
      document.getElementById("equityPercent").textContent = (((equity-initialBalance)/initialBalance)*100).toFixed(2) + "%";
    }

    // === utility: close trade via UI button wrapper ===
    function closeTrade(index){
      closeTradeByIndex(index, false, "Manual");
    }

    // === small safety: keep prices clickable for charts (attach rows) ===
    // (re-attach to ensure highlight works even after dynamic changes)
    function reattachSymbolClicks(){
      document.querySelectorAll("#price-table tbody tr").forEach(row=>{
        row.onclick = () => {
          document.querySelectorAll("#price-table tbody tr").forEach(r=>r.classList.remove('selected'));
          row.classList.add('selected');
          const symbol = row.dataset.symbol;
          if(symbol) loadChart(symbol);
        };
      });
    }
    // call once on load
    document.addEventListener("DOMContentLoaded", reattachSymbolClicks);

  </script>

  <!-- header loader (unchanged) -->
  <script>
    fetch("header.html").then(r=>r.text()).then(d=>{
      document.getElementById("header-container").innerHTML = d;
      const s = document.createElement("script"); s.src = "header.js"; document.body.appendChild(s);
    }).catch(()=>{ /* ignore if absent */ });
  </script>
</body>
</html>
