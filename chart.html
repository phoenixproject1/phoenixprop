<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>چارت و ترید</title>
  <style>
    body {
      font-family: tahoma, sans-serif;
      direction: rtl;
      background: #f9f9f9;
      margin: 20px;
    }
    h1 {
      text-align: center;
    }
    .container {
      display: flex;
      gap: 20px;
    }
    .symbols-table {
      width: 25%;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
      overflow: hidden;
    }
    .symbols-table table {
      width: 100%;
      border-collapse: collapse;
    }
    .symbols-table th, .symbols-table td {
      border-bottom: 1px solid #eee;
      padding: 8px;
      text-align: center;
    }
    .symbols-table tr.selected {
      background: #dcdcdc;
      font-weight: bold;
    }
    .chart-area {
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
      overflow: hidden;
    }
    #tradingview_chart {
      width: 100%;
      height: 500px;
    }
    .trades-table {
      margin-top: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
      overflow: hidden;
    }
    .trades-table table {
      width: 100%;
      border-collapse: collapse;
    }
    .trades-table th, .trades-table td {
      border-bottom: 1px solid #eee;
      padding: 8px;
      text-align: center;
    }
    .buy { color: blue; font-weight: bold; }
    .sell { color: red; font-weight: bold; }
    .profit { color: blue; }
    .loss { color: red; }
    .summary-row td {
      font-weight: bold;
      background: #fafafa;
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      width: 300px;
      text-align: center;
    }
    .modal-content input {
      margin: 5px 0;
      width: 90%;
      padding: 5px;
    }
    .modal-content button {
      margin-top: 10px;
      padding: 8px 12px;
    }
  </style>
</head>
<body>
  <h1>پلتفرم ترید آزمایشی</h1>

  <div class="container">
    <!-- جدول نمادها -->
    <div class="symbols-table">
      <table id="symbolsTable">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Bid</th>
            <th>Ask</th>
          </tr>
        </thead>
        <tbody>
          <tr data-symbol="BINANCE:BTCUSDT"><td>BTC/USDT</td><td>26950</td><td>26955</td></tr>
          <tr data-symbol="BINANCE:ETHUSDT"><td>ETH/USDT</td><td>1650</td><td>1652</td></tr>
          <tr data-symbol="BINANCE:BNBUSDT"><td>BNB/USDT</td><td>215</td><td>216</td></tr>
        </tbody>
      </table>
    </div>

    <!-- چارت -->
    <div class="chart-area">
      <div id="tradingview_chart">
        ⏳ در حال بارگذاری چارت...
      </div>
    </div>
  </div>

  <!-- جدول معاملات -->
  <div class="trades-table">
    <table id="tradesTable">
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Type</th>
          <th>Volume</th>
          <th>Entry</th>
          <th>Commission</th>
          <th>P/L</th>
          <th>Close</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr class="summary-row">
          <td colspan="7">
            Balance: <span id="balance">10000</span> USDT |
            Equity: <span id="equity">10000</span> USDT
          </td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Modal تنظیمات -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <h3>تنظیمات</h3>
      <label>کمیسیون (%):</label>
      <input type="number" id="commissionInput" value="0.1">
      <label>حداکثر Drawdown روزانه (%):</label>
      <input type="number" id="dailyDDInput" value="5">
      <label>حداکثر Drawdown کلی (%):</label>
      <input type="number" id="totalDDInput" value="20">
      <br>
      <button onclick="saveSettings()">ذخیره</button>
      <button onclick="closeModal()">بستن</button>
    </div>
  </div>

  <button onclick="openModal()">⚙️ تنظیمات</button>

  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    let balance = 10000;
    let equity = 10000;
    let commissionRate = 0.1;

    // load chart
    let currentChart;
    function loadChart(symbol) {
      if (typeof TradingView !== "undefined" && TradingView.widget) {
        document.getElementById("tradingview_chart").innerHTML = "";
        currentChart = new TradingView.widget({
          "container_id": "tradingview_chart",
          "width": "100%",
          "height": "500",
          "symbol": symbol,
          "interval": "60",
          "timezone": "Etc/UTC",
          "theme": "light",
          "style": "1",
          "locale": "fa",
          "toolbar_bg": "#f1f3f6",
          "enable_publishing": false,
          "allow_symbol_change": false,
          "save_image": false
        });
      }
    }
    loadChart("BINANCE:BTCUSDT");

    // انتخاب نماد
    document.querySelectorAll("#symbolsTable tbody tr").forEach(row => {
      row.addEventListener("click", () => {
        document.querySelectorAll("#symbolsTable tbody tr").forEach(r => r.classList.remove("selected"));
        row.classList.add("selected");
        loadChart(row.dataset.symbol);
      });
    });

    // مدیریت modal
    function openModal() {
      document.getElementById("settingsModal").style.display = "flex";
    }
    function closeModal() {
      document.getElementById("settingsModal").style.display = "none";
    }
    function saveSettings() {
      commissionRate = parseFloat(document.getElementById("commissionInput").value) || 0.1;
      closeModal();
    }

    // شبیه‌سازی معامله (برای تست دستی)
    function addTrade(symbol, type, volume, entry) {
      const tbody = document.querySelector("#tradesTable tbody");
      const commission = (entry * volume * commissionRate / 100).toFixed(2);
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${symbol}</td>
        <td class="${type.toLowerCase()}">${type}</td>
        <td>${volume}</td>
        <td>${entry}</td>
        <td>${commission}</td>
        <td class="profit">0</td>
        <td><button onclick="closeTrade(this)">❌</button></td>
      `;
      tbody.appendChild(row);

      balance -= commission;
      updateSummary();
    }

    function closeTrade(btn) {
      const row = btn.closest("tr");
      row.remove();
      updateSummary();
    }

    function updateSummary() {
      document.getElementById("balance").innerText = balance.toFixed(2);
      document.getElementById("equity").innerText = equity.toFixed(2);
    }

    // تست اولیه
    addTrade("BTC/USDT", "Buy", 0.1, 27000);
    addTrade("ETH/USDT", "Sell", 1, 1600);
  </script>
</body>
</html>
