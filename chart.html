<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>چارت + ترید</title>
  <style>
    body { font-family: Tahoma, sans-serif; background: #fafafa; }
    h1 { text-align: center; }

    .container {
      display: flex;
      justify-content: center;
      gap: 20px;
      max-width: 1400px;
      margin: 20px auto;
    }
    .tradingview-widget-container {
      flex: 3;
      min-width: 800px;
      height: 600px;
      border: 1px solid #ccc;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      background: #fafafa;
    }
    .price-box {
      flex: 1;
      min-width: 320px;
      border: 1px solid #ccc;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 15px;
      text-align: left;
      overflow-y: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: center;
      font-size: 14px;
    }
    th {
      background: #f5f5f5;
      color: black;
      font-weight: bold;
    }
    .ask { color: blue; font-weight: bold; }
    .bid { color: green; font-weight: bold; }
    .change-pos { color: darkgreen; font-weight: bold; }
    .change-neg { color: darkred; font-weight: bold; }

    .trade-box {
      max-width: 1200px;
      margin: 30px auto;
      padding: 15px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .trade-controls { margin-bottom: 15px; text-align: center; }
    .trade-controls input, .trade-controls button {
      margin: 5px;
      padding: 8px;
    }
    .buy-btn { background: green; color: #fff; border: none; border-radius: 6px; }
    .sell-btn { background: red; color: #fff; border: none; border-radius: 6px; }
    .settings-btn { background: #555; color: #fff; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; }
    .close-btn { background: #444; color: #fff; border: none; border-radius: 6px; padding: 5px 10px; cursor: pointer; }

    .pnl-pos { color: green; font-weight: bold; }
    .pnl-neg { color: red; font-weight: bold; }

    .balance-box {
      margin-top: 15px;
      padding: 10px;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }
    .balance-pos { color: green; font-weight: bold; }
    .balance-neg { color: red; font-weight: bold; }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      width: 400px;
    }
    .modal-content h3 { margin-top: 0; }
    .modal-content label { display: block; margin: 10px 0 5px; }
    .modal-content input { width: 100%; padding: 6px; margin-bottom: 10px; }
    .remove-x { cursor: pointer; color: red; font-weight: bold; margin-left: 5px; }
  </style>
</head>
<body>
  <h1>چارت بازار + سیستم ترید آزمایشی</h1>

  <div class="container">
    <div class="tradingview-widget-container">
      <div id="tradingview_chart"></div>
    </div>
    <div class="price-box">
      <h3>آخرین قیمت‌ها</h3>
      <table id="price-table">
        <thead>
          <tr>
            <th>Ask</th>
            <th>Bid</th>
            <th>Change %</th>
            <th>Symbol</th>
          </tr>
        </thead>
        <tbody>
          <tr data-symbol="BTCUSDT">
            <td id="ask-BTCUSDT" class="ask">---</td>
            <td id="bid-BTCUSDT" class="bid">---</td>
            <td id="change-BTCUSDT">---</td>
            <td>BTCUSDT</td>
          </tr>
          <tr data-symbol="ETHUSDT">
            <td id="ask-ETHUSDT" class="ask">---</td>
            <td id="bid-ETHUSDT" class="bid">---</td>
            <td id="change-ETHUSDT">---</td>
            <td>ETHUSDT</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="trade-box">
    <div class="trade-controls">
      حجم: <input type="number" id="tradeVolume" value="1" min="0.01" step="0.01"> 
      کمیسیون (%): <input type="number" id="commission" value="0.1" step="0.01" style="width:60px;">
      <button class="buy-btn" onclick="openTrade('BUY')">خرید</button>
      <button class="sell-btn" onclick="openTrade('SELL')">فروش</button>
    </div>
    <table id="trades-table">
      <thead>
        <tr>
          <th>Symbol</th>
          <th>نوع</th>
          <th>حجم</th>
          <th>قیمت ورود</th>
          <th>سود/ضرر</th>
          <th>TP</th>
          <th>SL</th>
          <th>TS</th>
          <th>تنظیمات</th>
          <th>بستن</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="balanceBox" class="balance-box">
      موجودی واقعی: <span id="realBalanceValue">10000.00</span> USDT 
      (<span id="realBalancePercent">0.00%</span>) <br>
      موجودی کل (Equity): <span id="equityValue">10000.00</span> USDT 
      (<span id="equityPercent">0.00%</span>)
    </div>
  </div>

  <!-- Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <h3>تنظیم حد سود/ضرر و Trailing Stop</h3>
      <label>حد سود (Take Profit):</label>
      <input type="number" id="tpInput" placeholder="مثلاً 25000">
      <label>حد ضرر (Stop Loss):</label>
      <input type="number" id="slInput" placeholder="مثلاً 19000">
      <label>Trailing Stop:</label>
      <input type="number" id="tsInput" placeholder="مثلاً 200">
      <button onclick="saveSettings()">ذخیره</button>
      <button onclick="closeModal()">بستن</button>
    </div>
  </div>

  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    let trades = [];
    let selectedTradeIndex = null;
    let initialBalance = 10000;
    let balance = 10000;

    function loadChart(symbol) {
      document.getElementById("tradingview_chart").innerHTML = ""; 
      new TradingView.widget({
        "container_id": "tradingview_chart",
        "width": "100%",
        "height": "600",
        "symbol": "BINANCE:" + symbol,
        "interval": "60",
        "timezone": "Etc/UTC",
        "theme": "light",
        "style": "1",
        "locale": "fa",
        "enable_publishing": false,
        "allow_symbol_change": false,
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadChart("BTCUSDT");
      updatePrices();
      setInterval(updatePrices, 3000);
    });

    async function updatePrices() {
      const symbols = ["BTCUSDT","ETHUSDT"];
      for (const sym of symbols) {
        try {
          const res = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${sym}`);
          const data = await res.json();
          document.getElementById("bid-" + sym).textContent = parseFloat(data.bidPrice).toFixed(2);
          document.getElementById("ask-" + sym).textContent = parseFloat(data.askPrice).toFixed(2);
          document.getElementById("change-" + sym).textContent = parseFloat(data.priceChangePercent).toFixed(2) + "%";
        } catch {}
      }
      updatePNL();
    }

    function openTrade(type) {
      const volume = parseFloat(document.getElementById("tradeVolume").value);
      const commission = parseFloat(document.getElementById("commission").value) / 100;
      const symbol = "BTCUSDT"; // تست اولیه
      const price = type==="BUY"?parseFloat(document.getElementById("ask-"+symbol).textContent):parseFloat(document.getElementById("bid-"+symbol).textContent);
      const fee = price * volume * commission;
      balance -= fee;
      trades.push({symbol,type,volume,entry:price,tp:null,sl:null,ts:null,trailActive:null,pnl:0});
      renderTrades();
      updateBalance();
    }

    function renderTrades() {
      const tbody = document.querySelector("#trades-table tbody");
      tbody.innerHTML = "";
      trades.forEach((t,i)=>{
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${t.symbol}</td>
          <td>${t.type}</td>
          <td>${t.volume}</td>
          <td>${t.entry}</td>
          <td id="pnl-${i}">0.00</td>
          <td>${t.tp? t.tp+' <span class="remove-x" onclick="removeSetting('+i+',\'tp\')">❌</span>' : '-'}</td>
          <td>${t.sl? t.sl+' <span class="remove-x" onclick="removeSetting('+i+',\'sl\')">❌</span>' : '-'}</td>
          <td>${t.ts? t.ts+' <span class="remove-x" onclick="removeSetting('+i+',\'ts\')">❌</span>' : '-'}</td>
          <td><button class="settings-btn" onclick="openModal(${i})">⚙️</button></td>
          <td><button class="close-btn" onclick="closeTrade(${i})">❌</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    function updatePNL() {
      trades.forEach((t,i)=>{
        const bid = parseFloat(document.getElementById("bid-"+t.symbol).textContent)||t.entry;
        const ask = parseFloat(document.getElementById("ask-"+t.symbol).textContent)||t.entry;
        const price = t.type==="BUY"?bid:ask;
        let pnl = (t.type==="BUY"?(price-t.entry):(t.entry-price))*t.volume;
        t.pnl = pnl;

        if(t.tp && ((t.type==="BUY" && price>=t.tp) || (t.type==="SELL" && price<=t.tp))) {
          closeTrade(i,true,"TP Hit");
        } else if(t.sl && ((t.type==="BUY" && price<=t.sl) || (t.type==="SELL" && price>=t.sl))) {
          closeTrade(i,true,"SL Hit");
        }

        if(t.ts){
          if(!t.trailActive){ t.trailActive = t.entry; }
          if(t.type==="BUY"){
            if(price>t.trailActive){ t.trailActive=price; }
            if(price <= t.trailActive - t.ts){ closeTrade(i,true,"TS Hit"); }
          } else {
            if(price<t.trailActive){ t.trailActive=price; }
            if(price >= t.trailActive + t.ts){ closeTrade(i,true,"TS Hit"); }
          }
        }

        const el=document.getElementById("pnl-"+i);
        if(el){
          el.textContent=pnl.toFixed(2);
          el.className=pnl>=0?"pnl-pos":"pnl-neg";
        }
      });
      updateBalance();
    }

    function closeTrade(i,auto=false,reason="Manual"){
      balance += trades[i].pnl;
      trades.splice(i,1);
      renderTrades();
      updateBalance();
      if(auto){ alert("معامله به دلیل "+reason+" بسته شد"); }
    }

    function updateBalance(){
      let unrealized=0;
      trades.forEach(t=>unrealized+=t.pnl);
      const equity=balance+unrealized;
      const realChange=((balance-initialBalance)/initialBalance*100).toFixed(2);
      const equityChange=((equity-initialBalance)/initialBalance*100).toFixed(2);

      document.getElementById("realBalanceValue").textContent=balance.toFixed(2);
      document.getElementById("equityValue").textContent=equity.toFixed(2);
      document.getElementById("realBalancePercent").textContent=realChange+"%";
      document.getElementById("equityPercent").textContent=equityChange+"%";
    }

    function openModal(i){ 
      selectedTradeIndex=i; 
      document.getElementById("tpInput").value = trades[i].tp || "";
      document.getElementById("slInput").value = trades[i].sl || "";
      document.getElementById("tsInput").value = trades[i].ts || "";
      document.getElementById("settingsModal").style.display="flex"; 
    }
    function closeModal(){ document.getElementById("settingsModal").style.display="none"; }
    function saveSettings(){
      const tp=document.getElementById("tpInput").value||null;
      const sl=document.getElementById("slInput").value||null;
      const ts=document.getElementById("tsInput").value||null;
      if(selectedTradeIndex!==null){
        trades[selectedTradeIndex].tp=tp?parseFloat(tp):null;
        trades[selectedTradeIndex].sl=sl?parseFloat(sl):null;
        trades[selectedTradeIndex].ts=ts?parseFloat(ts):null;
        trades[selectedTradeIndex].trailActive=null;
      }
      closeModal();
      renderTrades();
    }
    function removeSetting(i,type){
      trades[i][type]=null;
      if(type==="ts"){ trades[i].trailActive=null; }
      renderTrades();
    }
  </script>
</body>
</html>
